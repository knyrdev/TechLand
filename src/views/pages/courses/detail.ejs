<%- layout('layouts/main') %>

<section class="section">
    <div class="container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb mb-4">
            <a href="/">Inicio</a>
            <span>/</span>
            <a href="/cursos">Cursos</a>
            <span>/</span>
            <span><%= course.titulo %></span>
        </nav>
        
        <div class="row">
            <!-- Course Content -->
            <div class="col-lg-8">
                <div class="course-header mb-4">
                    <div class="d-flex align-items-center gap-2 mb-3">
                        <span class="level-badge <%= course.nivel %>">
                            <%= course.nivel %>
                        </span>
                        <% if (course.destacado) { %>
                            <span class="badge badge-popular">
                                <i class="bi bi-star-fill"></i> Popular
                            </span>
                        <% } %>
                    </div>
                    
                    <h1 class="course-title"><%= course.titulo %></h1>
                    
                    <p class="course-subtitle"><%= course.descripcion_corta || '' %></p>
                    
                    <div class="course-meta">
                        <% if (course.calificacion_promedio > 0) { %>
                            <span class="meta-item rating">
                                <i class="bi bi-star-fill text-warning"></i>
                                <strong><%= parseFloat(course.calificacion_promedio || 0).toFixed(1) %></strong>
                                (<%= course.total_resenas || 0 %> valoraciones)
                            </span>
                        <% } %>
                        <span class="meta-item">
                            <i class="bi bi-people"></i>
                            <%= course.total_estudiantes || 0 %> estudiantes
                        </span>
                        <span class="meta-item">
                            <i class="bi bi-clock"></i>
                            <%= course.duracion_horas %> horas
                        </span>
                        <% if (course.total_lecciones) { %>
                            <span class="meta-item">
                                <i class="bi bi-collection-play"></i>
                                <%= course.total_lecciones %> lecciones
                            </span>
                        <% } %>
                    </div>
                    
                    <div class="instructor-info mt-3">
                        <div class="instructor-avatar">
                            <i class="bi bi-person-circle"></i>
                        </div>
                        <div>
                            <span class="text-muted">Instructor</span>
                            <p class="instructor-name mb-0"><%= course.instructor %></p>
                        </div>
                    </div>
                </div>
                
                <!-- Course Video Preview -->
                <div class="course-preview mb-4">
                    <div class="video-placeholder">
                        <i class="bi bi-play-circle"></i>
                        <span>Vista previa del curso</span>
                    </div>
                </div>
                
                <!-- Course Tabs -->
                <div class="course-tabs">
                    <ul class="nav nav-tabs" role="tablist">
                        <li class="nav-item">
                            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#description">
                                Descripción
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#content">
                                Contenido
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#reviews">
                                Reseñas
                            </button>
                        </li>
                    </ul>
                    
                    <div class="tab-content">
                        <!-- Description Tab -->
                        <div class="tab-pane fade show active" id="description">
                            <div class="course-description">
                                <h4>Acerca de este curso</h4>
                                <%= course.descripcion %>
                                
                                <% if (course.requisitos) { %>
                                    <h4 class="mt-4">Requisitos</h4>
                                    <ul class="requirements-list">
                                        <% course.requisitos.split('\n').forEach(req => { %>
                                            <% if (req.trim()) { %>
                                                <li><i class="bi bi-check-circle"></i> <%= req.trim() %></li>
                                            <% } %>
                                        <% }); %>
                                    </ul>
                                <% } %>
                                
                                <h4 class="mt-4">Lo que aprenderás</h4>
                                <div class="learn-grid">
                                    <% const topics = [
                                        'Diagnóstico de problemas comunes',
                                        'Uso de herramientas profesionales',
                                        'Técnicas de reparación seguras',
                                        'Microsoldadura básica y avanzada',
                                        'Cambio de componentes',
                                        'Atención al cliente profesional'
                                    ]; %>
                                    <% topics.forEach(topic => { %>
                                        <div class="learn-item">
                                            <i class="bi bi-check-circle-fill text-success"></i>
                                            <span><%= topic %></span>
                                        </div>
                                    <% }); %>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Content Tab -->
                        <div class="tab-pane fade" id="content">
                            <div class="course-curriculum">
                                <div class="curriculum-header">
                                    <h4>Contenido del curso</h4>
                                    <span class="text-muted">
                                        <%= course.total_lecciones || '10' %> lecciones • 
                                        <%= course.duracion_horas %> horas de contenido
                                    </span>
                                </div>
                                
                                <% if (typeof lessons !== 'undefined' && lessons && lessons.length > 0) { %>
                                    <div class="curriculum-list">
                                        <% lessons.forEach((lesson, idx) => { %>
                                            <div class="curriculum-item">
                                                <div class="lesson-info">
                                                    <span class="lesson-number"><%= idx + 1 %></span>
                                                    <span class="lesson-title"><%= lesson.titulo %></span>
                                                </div>
                                                <span class="lesson-duration"><%= lesson.duracion_minutos %> min</span>
                                            </div>
                                        <% }); %>
                                    </div>
                                <% } else { %>
                                    <!-- Sample curriculum -->
                                    <div class="accordion curriculum-accordion" id="curriculumAccordion">
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#module1">
                                                    <span class="module-title">Módulo 1: Introducción y Herramientas</span>
                                                    <span class="module-meta">4 lecciones • 45 min</span>
                                                </button>
                                            </h2>
                                            <div id="module1" class="accordion-collapse collapse show" data-bs-parent="#curriculumAccordion">
                                                <div class="accordion-body">
                                                    <div class="curriculum-item">
                                                        <div class="lesson-info">
                                                            <i class="bi bi-play-circle"></i>
                                                            <span>Bienvenida al curso</span>
                                                        </div>
                                                        <span class="lesson-duration">5 min</span>
                                                    </div>
                                                    <div class="curriculum-item">
                                                        <div class="lesson-info">
                                                            <i class="bi bi-play-circle"></i>
                                                            <span>Herramientas necesarias</span>
                                                        </div>
                                                        <span class="lesson-duration">15 min</span>
                                                    </div>
                                                    <div class="curriculum-item">
                                                        <div class="lesson-info">
                                                            <i class="bi bi-play-circle"></i>
                                                            <span>Configuración del espacio de trabajo</span>
                                                        </div>
                                                        <span class="lesson-duration">12 min</span>
                                                    </div>
                                                    <div class="curriculum-item">
                                                        <div class="lesson-info">
                                                            <i class="bi bi-play-circle"></i>
                                                            <span>Normas de seguridad</span>
                                                        </div>
                                                        <span class="lesson-duration">13 min</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="accordion-item">
                                            <h2 class="accordion-header">
                                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#module2">
                                                    <span class="module-title">Módulo 2: Diagnóstico</span>
                                                    <span class="module-meta">5 lecciones • 1h 20min</span>
                                                </button>
                                            </h2>
                                            <div id="module2" class="accordion-collapse collapse" data-bs-parent="#curriculumAccordion">
                                                <div class="accordion-body">
                                                    <div class="curriculum-item">
                                                        <div class="lesson-info">
                                                            <i class="bi bi-lock"></i>
                                                            <span>Diagnóstico inicial</span>
                                                        </div>
                                                        <span class="lesson-duration">20 min</span>
                                                    </div>
                                                    <div class="curriculum-item">
                                                        <div class="lesson-info">
                                                            <i class="bi bi-lock"></i>
                                                            <span>Problemas de software vs hardware</span>
                                                        </div>
                                                        <span class="lesson-duration">25 min</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                        
                        <!-- Reviews Tab -->
                        <div class="tab-pane fade" id="reviews">
                            <div class="course-reviews">
                                <div class="reviews-summary">
                                    <div class="rating-big">
                                        <span class="rating-number"><%= parseFloat(course.calificacion_promedio || 0).toFixed(1) %></span>
                                        <div class="stars">
                                            <% for (let i = 1; i <= 5; i++) { %>
                                                <i class="bi bi-star<%= i <= Math.round(parseFloat(course.calificacion_promedio) || 0) ? '-fill' : '' %>"></i>
                                            <% } %>
                                        </div>
                                        <span class="rating-count"><%= course.total_resenas || 0 %> valoraciones</span>
                                    </div>
                                </div>
                                
                                <% if (typeof reviews !== 'undefined' && reviews && reviews.length > 0) { %>
                                    <div class="reviews-list">
                                        <% reviews.forEach(review => { %>
                                            <div class="review-item">
                                                <div class="review-header">
                                                    <div class="reviewer-avatar">
                                                        <i class="bi bi-person-circle"></i>
                                                    </div>
                                                    <div class="reviewer-info">
                                                        <h6><%= review.usuario_nombre %></h6>
                                                        <div class="d-flex align-items-center gap-2">
                                                            <div class="stars small">
                                                                <% for (let i = 1; i <= 5; i++) { %>
                                                                    <i class="bi bi-star<%= i <= review.calificacion ? '-fill' : '' %>"></i>
                                                                <% } %>
                                                            </div>
                                                            <span class="text-muted small"><%= new Date(review.fecha).toLocaleDateString() %></span>
                                                        </div>
                                                    </div>
                                                </div>
                                                <p class="review-text"><%= review.comentario %></p>
                                            </div>
                                        <% }); %>
                                    </div>
                                <% } else { %>
                                    <div class="empty-reviews">
                                        <i class="bi bi-chat-square-text"></i>
                                        <p>Aún no hay reseñas para este curso</p>
                                    </div>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Sidebar -->
            <div class="col-lg-4">
                <div class="course-sidebar">
                    <div class="card sticky-card">
                        <div class="card-body">
                            <div class="price-container mb-4">
                                <% if (course.precio_oferta) { %>
                                    <span class="current-price">$<%= parseFloat(course.precio_oferta).toFixed(2) %></span>
                                    <span class="original-price">$<%= parseFloat(course.precio).toFixed(2) %></span>
                                    <span class="discount-badge">
                                        -<%= Math.round((1 - parseFloat(course.precio_oferta) / parseFloat(course.precio)) * 100) %>% OFF
                                    </span>
                                <% } else { %>
                                    <span class="current-price">$<%= parseFloat(course.precio).toFixed(2) %></span>
                                <% } %>
                            </div>
                            
                            <form action="/cart/add" method="POST" class="add-to-cart-form">
                                <input type="hidden" name="id" value="<%= course.id_curso %>">
                                <input type="hidden" name="type" value="curso">
                                
                                <div class="d-grid gap-2 mb-4">
                                    <button type="submit" class="btn btn-primary btn-lg">
                                        <i class="bi bi-cart-plus"></i> Comprar curso
                                    </button>
                                </div>
                            </form>
                            
                            <p class="text-center text-muted small mb-4">
                                <i class="bi bi-shield-check"></i> Garantía de 30 días
                            </p>
                            
                            <div class="course-includes">
                                <h6>Este curso incluye:</h6>
                                <ul>
                                    <li><i class="bi bi-play-circle"></i> <%= course.duracion_horas %> horas de video</li>
                                    <li><i class="bi bi-collection-play"></i> <%= course.total_lecciones || '10+' %> lecciones</li>
                                    <li><i class="bi bi-infinity"></i> Acceso de por vida</li>
                                    <li><i class="bi bi-phone"></i> Acceso en móvil y TV</li>
                                    <li><i class="bi bi-patch-check"></i> Certificado de finalización</li>
                                    <li><i class="bi bi-download"></i> Recursos descargables</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Related Courses -->
<% if (typeof relatedCourses !== 'undefined' && relatedCourses && relatedCourses.length > 0) { %>
<section class="section section-dark">
    <div class="container">
        <h2 class="section-title">Cursos Relacionados</h2>
        <div class="row g-4">
            <% relatedCourses.slice(0, 3).forEach(related => { %>
                <div class="col-md-4">
                    <div class="card course-card h-100">
                        <div class="card-img-wrapper">
                            <i class="bi bi-mortarboard"></i>
                        </div>
                        <div class="card-body">
                            <span class="level-badge <%= related.nivel %>"><%= related.nivel %></span>
                            <h5 class="card-title mt-2"><%= related.titulo %></h5>
                            <p class="text-muted small"><i class="bi bi-person"></i> <%= related.instructor %></p>
                            <div class="d-flex justify-content-between align-items-center">
                                <span class="card-price">$<%= parseFloat(related.precio_oferta || related.precio).toFixed(2) %></span>
                                <a href="/cursos/<%= related.slug %>" class="btn btn-outline btn-sm">Ver curso</a>
                            </div>
                        </div>
                    </div>
                </div>
            <% }); %>
        </div>
    </div>
</section>
<% } %>