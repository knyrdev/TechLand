<%- layout('layouts/main') %>

<section class="section">
    <div class="container">
        <h1 class="section-title mb-5">
            <i class="bi bi-cart3 text-accent"></i> Carrito de Compras
        </h1>
        
        <% if (typeof cart === 'undefined' || cart.length === 0) { %>
            <!-- Empty Cart -->
            <div class="empty-state">
                <div class="empty-state-icon">
                    <i class="bi bi-cart-x"></i>
                </div>
                <h3 class="empty-state-title">Tu carrito está vacío</h3>
                <p class="empty-state-text">Parece que aún no has agregado nada a tu carrito.</p>
                <div class="d-flex flex-wrap justify-content-center gap-3">
                    <a href="/productos" class="btn btn-primary">
                        <i class="bi bi-box-seam"></i> Ver Productos
                    </a>
                    <a href="/cursos" class="btn btn-outline">
                        <i class="bi bi-mortarboard"></i> Ver Cursos
                    </a>
                    <a href="/servicios" class="btn btn-outline">
                        <i class="bi bi-tools"></i> Ver Servicios
                    </a>
                </div>
            </div>
        <% } else { %>
            <div class="row">
                <!-- Cart Items -->
                <div class="col-lg-8 mb-4">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="bi bi-bag"></i> 
                                Items (<%= typeof itemCount !== 'undefined' ? itemCount : cart.length %>)
                            </h5>
                            <form action="/cart/clear" method="POST" style="display: inline;">
                                <button type="submit" class="btn btn-sm" style="color: var(--color-error);">
                                    <i class="bi bi-trash"></i> Vaciar carrito
                                </button>
                            </form>
                        </div>
                        <div class="card-body p-0">
                            <% cart.forEach((item, index) => { %>
                                <div class="cart-item <%= index < cart.length - 1 ? '' : 'border-0' %>">
                                    <div class="cart-item-image">
                                        <i class="bi bi-<%= item.type === 'producto' || item.type === 'product' ? 'box' : item.type === 'curso' || item.type === 'course' ? 'play-circle' : 'tools' %>"></i>
                                    </div>
                                    <div class="cart-item-details">
                                        <h6 class="cart-item-name"><%= item.name %></h6>
                                        <span class="cart-item-type">
                                            <% if (item.type === 'producto' || item.type === 'product') { %>
                                                <i class="bi bi-box"></i> Producto
                                            <% } else if (item.type === 'curso' || item.type === 'course') { %>
                                                <i class="bi bi-mortarboard"></i> Curso
                                            <% } else { %>
                                                <i class="bi bi-tools"></i> Servicio
                                            <% } %>
                                        </span>
                                        <% if (item.category) { %>
                                            <span class="text-muted small ms-2"><%= item.category %></span>
                                        <% } %>
                                    </div>
                                    <div class="text-end me-4">
                                        <span class="d-block text-muted small">Precio</span>
                                        <strong class="text-accent">$<%= parseFloat(item.price || 0).toFixed(2) %></strong>
                                    </div>
                                    <div class="me-4">
                                        <% if (item.type === 'producto' || item.type === 'product') { %>
                                            <div class="quantity-control">
                                                <button type="button" onclick="updateQuantity(<%= item.id %>, '<%= item.type %>', <%= item.quantity - 1 %>)">
                                                    <i class="bi bi-dash"></i>
                                                </button>
                                                <input type="text" value="<%= item.quantity %>" readonly>
                                                <button type="button" onclick="updateQuantity(<%= item.id %>, '<%= item.type %>', <%= item.quantity + 1 %>)">
                                                    <i class="bi bi-plus"></i>
                                                </button>
                                            </div>
                                        <% } else { %>
                                            <span class="badge bg-secondary">x1</span>
                                        <% } %>
                                    </div>
                                    <div class="text-end me-3">
                                        <span class="d-block text-muted small">Subtotal</span>
                                        <strong>$<%= (parseFloat(item.price || 0) * item.quantity).toFixed(2) %></strong>
                                    </div>
                                    <form action="/cart/remove" method="POST" style="display: inline;">
                                        <input type="hidden" name="id" value="<%= item.id %>">
                                        <input type="hidden" name="type" value="<%= item.type %>">
                                        <button type="submit" class="btn btn-sm" style="color: var(--color-error);">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </form>
                                </div>
                            <% }); %>
                        </div>
                    </div>
                    
                    <!-- Continue Shopping -->
                    <div class="d-flex gap-3 mt-4">
                        <a href="/productos" class="btn btn-outline">
                            <i class="bi bi-arrow-left"></i> Seguir comprando
                        </a>
                    </div>
                </div>
                
                <!-- Order Summary -->
                <div class="col-lg-4">
                    <div class="cart-summary">
                        <h5 class="mb-4">Resumen del pedido</h5>
                        
                        <div class="cart-summary-row">
                            <span class="text-secondary">Subtotal</span>
                            <span>$<%= subtotal %></span>
                        </div>
                        <div class="cart-summary-row">
                            <span class="text-secondary">IVA (16%)</span>
                            <span>$<%= tax %></span>
                        </div>
                        <div class="cart-summary-row">
                            <span class="text-secondary">Envío</span>
                            <span class="text-success">Gratis</span>
                        </div>
                        <div class="cart-summary-row total">
                            <span>Total</span>
                            <span class="text-accent">$<%= total %></span>
                        </div>
                        
                        <div class="d-grid mt-4">
                            <a href="/cart/checkout" class="btn btn-primary btn-lg">
                                <i class="bi bi-credit-card"></i> Proceder al pago
                            </a>
                        </div>
                        
                        <!-- Payment Methods -->
                        <div class="text-center mt-4">
                            <p class="text-muted small mb-2">Métodos de pago aceptados</p>
                            <div class="d-flex justify-content-center gap-2">
                                <i class="bi bi-credit-card-2-front" style="font-size: 1.5rem;"></i>
                                <i class="bi bi-paypal" style="font-size: 1.5rem;"></i>
                                <i class="bi bi-cash" style="font-size: 1.5rem;"></i>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Promo Code -->
                    <div class="card mt-4">
                        <div class="card-body">
                            <h6 class="mb-3">
                                <i class="bi bi-ticket-perforated text-accent"></i> Código promocional
                            </h6>
                            <div class="input-group">
                                <input type="text" class="form-control" placeholder="Ingresa tu código">
                                <button class="btn btn-outline" type="button">Aplicar</button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Security Badge -->
                    <div class="text-center mt-4">
                        <p class="text-muted small mb-0">
                            <i class="bi bi-shield-check text-success"></i>
                            Compra 100% segura
                        </p>
                    </div>
                </div>
            </div>
        <% } %>
    </div>
</section>

<script>
function updateQuantity(id, type, quantity) {
    if (quantity < 1) {
        if (confirm('¿Eliminar este item del carrito?')) {
            removeItem(id, type);
        }
        return;
    }
    
    fetch('/cart/update', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({ id, type, quantity })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        } else {
            alert(data.error || 'Error al actualizar');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        window.location.reload();
    });
}

function removeItem(id, type) {
    fetch('/cart/remove', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        },
        body: JSON.stringify({ id, type })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            window.location.reload();
        }
    })
    .catch(error => {
        console.error('Error:', error);
        window.location.reload();
    });
}
</script>